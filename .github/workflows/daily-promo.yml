name: Daily Promo

# 임시 비활성화 - AdSense 승인 후 활성화 예정
# on:
#   schedule:
#     # 매일 오전 9시 UTC (한국시간 오후 6시)
#     - cron: '0 9 * * *'
#   workflow_dispatch: # 수동 실행 가능

on:
  workflow_dispatch: # 수동 실행만 가능 (스케줄 비활성화)

jobs:
  promo:
    runs-on: ubuntu-latest
    steps:
      - name: Send promo to all platforms
        run: |
          response=$(curl -s -X POST "https://ddangit.vercel.app/api/promo/all" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.PROMO_API_KEY }}")

          echo "Response: $response"

          # Check if success
          if echo "$response" | grep -q '"success":true'; then
            echo "✅ Promo sent successfully!"
          else
            echo "❌ Promo failed"
            exit 1
          fi

  notify-failure:
    runs-on: ubuntu-latest
    needs: promo
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          curl -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "from": "ddangit <noreply@ddangit.vercel.app>",
              "to": ["${{ secrets.NOTIFICATION_EMAIL }}"],
              "subject": "❌ Daily Promo Failed - ddangit",
              "html": "<h2>홍보 발송 실패</h2><p>Daily Promo가 실패했습니다.</p><p><a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">로그 확인하기</a></p>"
            }'
